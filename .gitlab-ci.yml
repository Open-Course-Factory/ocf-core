default:
  tags:
    - ocf-core

variables:
  # PostgreSQL configuration for tests
  POSTGRES_DB: ocf_test
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres_test_password
  POSTGRES_HOST: postgres
  POSTGRES_PORT: "5432"
  POSTGRES_SSLMODE: disable
  GO_VERSION: "1.24"

stages:
  - test
  - build

# Entity Management Tests with PostgreSQL
test:entity-management:
  stage: test
  image: golang:${GO_VERSION}

  services:
    - name: postgres:15-alpine
      alias: postgres

  variables:
    POSTGRES_DB: $POSTGRES_DB
    POSTGRES_USER: $POSTGRES_USER
    POSTGRES_PASSWORD: $POSTGRES_PASSWORD

  before_script:
    # Wait for PostgreSQL to be ready (service starts automatically)
    - apt-get update -qq && apt-get install -y -qq postgresql-client
    - |
      echo "â³ Waiting for PostgreSQL service to be ready..."
      for i in $(seq 1 30); do
        if PGPASSWORD=$POSTGRES_PASSWORD psql -h $POSTGRES_HOST -U $POSTGRES_USER -d $POSTGRES_DB -c '\q' 2>/dev/null; then
          echo "âœ… PostgreSQL is ready!"
          break
        fi
        if [ $i -eq 30 ]; then
          echo "âŒ PostgreSQL failed to start after 30 seconds"
          exit 1
        fi
        sleep 1
      done
    - go mod download

  script:
    # Run all tests (SQLite + PostgreSQL)
    - echo "ðŸ“¦ Compiling tests..."
    - go test -c -o entity_tests.exe ./tests/entityManagement

    - echo "ðŸ§ª Running SQLite-based tests..."
    - ./entity_tests.exe -test.v -test.timeout=60s -test.run "TestGeneric|TestEntityRegistration|TestSecurity|TestIntegration"

    - echo "ðŸ˜ Running PostgreSQL-specific tests..."
    - ./entity_tests.exe -test.v -test.timeout=60s -test.run "TestPostgres"

    - echo "ðŸ“Š Generating coverage..."
    - go test -v -coverprofile=coverage.out ./tests/entityManagement -timeout=90s

  coverage: '/total:\s+\(statements\)\s+(\d+\.\d+)%/'

  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.out
    paths:
      - coverage.out
    expire_in: 1 week

  only:
    - merge_requests
    - main
    - develop

# Quick validation (no PostgreSQL)
test:quick:
  stage: test
  image: golang:${GO_VERSION}

  before_script:
    - go mod download

  script:
    - echo "âš¡ Running quick tests..."
    - go test -c -o entity_tests.exe ./tests/entityManagement
    - ./entity_tests.exe -test.v -test.short -test.timeout=30s

  only:
    - merge_requests

# Race detector
test:race:
  stage: test
  image: golang:${GO_VERSION}

  services:
    - name: postgres:15-alpine
      alias: postgres

  variables:
    POSTGRES_DB: $POSTGRES_DB
    POSTGRES_USER: $POSTGRES_USER
    POSTGRES_PASSWORD: $POSTGRES_PASSWORD

  before_script:
    # Wait for PostgreSQL to be ready (service starts automatically)
    - apt-get update -qq && apt-get install -y -qq postgresql-client
    - |
      echo "â³ Waiting for PostgreSQL service to be ready..."
      for i in $(seq 1 30); do
        if PGPASSWORD=$POSTGRES_PASSWORD psql -h $POSTGRES_HOST -U $POSTGRES_USER -d $POSTGRES_DB -c '\q' 2>/dev/null; then
          echo "âœ… PostgreSQL is ready!"
          break
        fi
        if [ $i -eq 30 ]; then
          echo "âŒ PostgreSQL failed to start after 30 seconds"
          exit 1
        fi
        sleep 1
      done
    - go mod download

  script:
    - echo "ðŸ Running race detector..."
    - go test -c -race -o entity_tests_race.exe ./tests/entityManagement
    - ./entity_tests_race.exe -test.v -test.timeout=120s

  only:
    - merge_requests
    - main

build:
  stage: build
  before_script:
    - echo $token_jwt_key | base64 -d > ./token_jwt_key.pem

include:
  - template: Jobs/Build.gitlab-ci.yml
